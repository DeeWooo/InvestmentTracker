# v0.1.3 改进：优先使用实时价格

## 改进目标

**移除或最小化模拟数据的使用**，确保系统始终优先使用实时价格获取，以提高计算准确性。

## 改进清单

### 1. 前端代码更新

#### [src/components/HomePage.tsx](../src/components/HomePage.tsx:20-33)
**改动**: 将模拟数据改为实时数据

```typescript
// 之前 (v0.1.2)
const data = await db.getPortfolioProfitLossView(true);  // 强制使用模拟数据

// 之后 (v0.1.3)
const data = await db.getPortfolioProfitLossView(false); // 优先使用实时价格
```

**影响**: 主页载入时现在会获取真实的实时价格，而不是随机生成的数据。

#### [src/components/PositionList.tsx](../src/components/PositionList.tsx:100-103)
**改动**: 持仓列表盈亏数据同样优先使用实时价格

```typescript
// 之前 (v0.1.2)
const data = await db.getPortfolioProfitLossView(true);  // 强制使用模拟数据

// 之后 (v0.1.3)
const data = await db.getPortfolioProfitLossView(false); // 优先使用实时价格
```

**影响**: 持仓列表显示的盈亏率和目标盈亏现在基于真实实时价格。

#### [src/components/PortfolioProfitLossView.tsx](../src/components/PortfolioProfitLossView.tsx:34-44)
**改动**: 移除对模拟数据的静默降级，改为显示错误

```typescript
// 之前 (v0.1.2)
try {
  data = await db.getPortfolioProfitLossView(false);
} catch (error) {
  console.warn("实时价格获取失败，使用模拟数据:", error);
  data = await db.getPortfolioProfitLossView(true); // 静默降级
}

// 之后 (v0.1.3)
try {
  data = await db.getPortfolioProfitLossView(false);
} catch (error) {
  console.warn("⚠️  获取数据失败:", error);
  throw error;  // 显示实际错误而不是静默降级
}
```

**影响**: 当实时价格获取失败时，用户会看到明确的错误提示，而不是不知道使用了模拟数据。

#### [src/lib/db.ts](../src/lib/db.ts:232)
**改动**: 改变默认参数，优先使用实时价格

```typescript
// 之前 (v0.1.2)
async getPortfolioProfitLossView(useMock: boolean = true): Promise<PortfolioProfitLoss[]> {
  // 默认使用模拟数据

// 之后 (v0.1.3)
async getPortfolioProfitLossView(useMock: boolean = false): Promise<PortfolioProfitLoss[]> {
  // 默认优先使用实时价格
```

**影响**: 所有调用此方法且未显式指定参数的地方，都会优先获取实时价格。

### 2. 后端行为（无需代码改动）

后端的降级逻辑保持不变，逻辑如下：

```
用户请求 use_mock=false（默认）
    ↓
尝试从腾讯财经API获取实时价格
    ↓
    成功？ → 返回实时价格数据
    失败？ ↓
    部分成功？ → 混合真实数据 + 模拟数据
           ↓
           完全失败？ → 返回纯模拟数据（自动降级）
```

**关键点**:
- ✅ 实时价格成功时，返回纯真实数据（不混入模拟数据）
- ⚠️ 部分实时价格失败时，为失败的股票生成模拟数据（最小化影响）
- ⚠️ 完全失败时，自动降级到全模拟数据（保证功能可用）

## 改进效果对比

### v0.1.2（改进前）

| 场景 | 行为 | 数据准确性 |
|------|------|---------|
| 主页载入 | 直接使用模拟数据 ❌ | 完全不可信 |
| 持仓列表 | 直接使用模拟数据 ❌ | 完全不可信 |
| 盈亏视图 | 尝试实时，失败时静默降级 ⚠️ | 用户不知道使用的是哪种数据 |

**用户体验**: 用户看到的所有盈亏数据都基于随机生成的模拟价格，无法做出准确的投资决策。

### v0.1.3（改进后）

| 场景 | 行为 | 数据准确性 |
|------|------|---------|
| 主页载入 | 优先实时价格 ✅ | 基于真实行情 |
| 持仓列表 | 优先实时价格 ✅ | 基于真实行情 |
| 盈亏视图 | 优先实时，失败显示错误 ✅ | 用户明确知道数据状态 |

**用户体验**: 用户默认获得基于真实实时价格的数据，当网络或API失败时收到明确提示。

## 技术细节

### 腾讯财经API 实时价格获取流程

```
1. 前端调用 db.getPortfolioProfitLossView(false)
                    ↓
2. 后端接收 use_mock=false 参数
                    ↓
3. 后端调用 QuoteService::fetch_real_quotes(codes)
                    ↓
4. 格式化股票代码 (600519 → sh600519)
                    ↓
5. HTTP 请求腾讯 API: http://qt.gtimg.cn/q=sh600519,sz000001,...
                    ↓
6. 解析响应获取实时价格
                    ↓
7. 如果成功: 返回实时价格 HashMap
   如果失败: 自动降级生成模拟价格
```

### 价格数据流向示意

```
PortfolioService
    ↓
    使用 quotes HashMap 计算盈亏
    ↓
    前端显示

其中 quotes 来源：
  - 主要来源: QuoteService::fetch_real_quotes() ✅
  - 备用来源: QuoteService::mock_quotes() (当API失败时)
```

## 后续改进建议（v0.1.4+）

### 短期（下一个版本）

1. **添加价格更新时间戳**
   - 显示实时价格的获取时间
   - 用户可以判断价格的新鲜度

2. **实现价格缓存**
   - 避免频繁请求API
   - 降低网络开销和API调用频率限制风险

3. **支持手动输入价格**
   - 当实时价格获取失败时，允许用户输入当前价格
   - 替代自动降级的模拟数据

### 中期（v0.1.5+）

1. **完善错误处理**
   - 区分不同类型的失败（网络错误、API限流、股票代码错误等）
   - 提供针对性的用户提示

2. **支持多个行情数据源**
   - 当腾讯API失败时，尝试备用数据源
   - 提高数据可用性

3. **添加有效性指示符**
   - 在UI上明确标识数据来源（实时/模拟/用户输入）
   - 使用视觉标记区分数据质量

## 测试检查清单

- [ ] 主页载入时是否使用了实时价格
  - 检查浏览器控制台日志：应看到 "✅ 实时价格获取成功"
  - 检查盈亏数据是否合理（而不是随机数字）

- [ ] 持仓列表的盈亏率是否基于实时价格
  - 对比持仓列表和盈亏视图的盈亏率，应该一致

- [ ] 网络中断时是否显示错误
  - 断网后刷新页面，应看到错误提示而不是模拟数据

- [ ] 后端日志是否显示价格获取过程
  - 查看控制台输出，应看到详细的获取步骤和结果

## 升级检查清单

若从 v0.1.2 升级到 v0.1.3：

1. ✅ 清除浏览器缓存（LocalStorage/SessionStorage）
2. ✅ 重新启动应用
3. ✅ 检查所有显示盈亏的页面是否数据一致
4. ✅ 测试网络中断时的错误处理

## 相关文档

- [计算规则文档](./calculation-rules.md) - 盈亏计算公式
- [项目结构](./project-structure.md) - 代码组织
- [README](../readme.md) - 项目概览

---

**版本**: v0.1.3
**更新日期**: 2025-11-14
**状态**: 实现完成，待测试验证
